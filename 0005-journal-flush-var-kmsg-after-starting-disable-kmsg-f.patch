From 171aa03057891537bc034e103138f371ce1f9f08 Mon Sep 17 00:00:00 2001
From: Dimitri John Ledkov <dimitri.j.ledkov@intel.com>
Date: Tue, 23 Jun 2015 11:38:31 +0100
Subject: [PATCH 05/38] journal: flush var/kmsg after starting, disable kmsg
 from boot.

---
 src/journal/journald-server.c | 4 +++-
 src/journal/journald.c        | 5 +++--
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/journal/journald-server.c b/src/journal/journald-server.c
index 18e3c18b8e..04a99dcfc0 100644
--- a/src/journal/journald-server.c
+++ b/src/journal/journald-server.c
@@ -2329,7 +2329,9 @@ int server_init(Server *s, const char *namespace) {
                 return r;
 
         /* By default, only read from /dev/kmsg if are the main namespace */
-        s->boot_kmsg = s->read_kmsg = !s->namespace;
+        s->read_kmsg = !s->namespace;
+        /* default in clearlinux is to not read kmsg from boot at all. Use BootKMsg=true in journald.conf instead if you need this */
+        s->boot_kmsg = false;
         s->storage = s->namespace ? STORAGE_PERSISTENT : STORAGE_AUTO;
 
         journal_reset_metrics(&s->system_storage.metrics);
diff --git a/src/journal/journald.c b/src/journal/journald.c
index 2f013c2ab2b2..c3dc8f4b7bef 100644
--- a/src/journal/journald.c
+++ b/src/journal/journald.c
@@ -57,8 +57,6 @@ static int run(int argc, char *argv[]) {
                 return r;
 
         server_vacuum(s, /* verbose = */ false);
-        server_flush_to_var(s, /* require_flag_file = */ true);
-        server_flush_dev_kmsg(s);
 
         if (s->namespace)
                 log_debug("systemd-journald running as PID "PID_FMT" for namespace '%s'.", getpid_cached(), s->namespace);
@@ -70,6 +68,9 @@ static int run(int argc, char *argv[]) {
                               LOG_MESSAGE("Journal started"),
                               NULL);
 
+        server_flush_to_var(s, /* require_flag_file = */ true);
+        server_flush_dev_kmsg(s);
+
         /* Make sure to send the usage message *after* flushing the
          * journal so entries from the runtime journals are ordered
          * before this message. See #4190 for some details. */
-- 
2.36.1

